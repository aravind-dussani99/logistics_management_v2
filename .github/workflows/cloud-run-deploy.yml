name: CI + Build + Deploy

on:
  pull_request:
    branches: [ main ]
    types: [opened, edited, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY }}
  BACKEND_SERVICE_NAME: ${{ vars.CLOUD_RUN_SERVICE }}
  BACKEND_SERVICE_NAME_DEV: ${{ vars.CLOUD_RUN_SERVICE_DEV }}
  FRONTEND_API_BASE_URL: ${{ vars.FRONTEND_API_BASE_URL }}
  CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
  CORS_ORIGIN_DEV: ${{ vars.CORS_ORIGIN_DEV }}
  FRONTEND_BUCKET: ${{ vars.FRONTEND_BUCKET }}
  FRONTEND_BUCKET_DEV: ${{ vars.FRONTEND_BUCKET_DEV }}
  CONFIG_BUCKET: ${{ vars.CONFIG_BUCKET || vars.FRONTEND_BUCKET }}
  CONFIG_BUCKET_DEV: ${{ vars.CONFIG_BUCKET_DEV || vars.FRONTEND_BUCKET_DEV }}
  IMAGE_NAME_BACKEND: ${{ vars.IMAGE_NAME_BACKEND || 'logitrack-api' }}
  CLOUDSQL_INSTANCE_CONNECTION: ${{ vars.CLOUDSQL_INSTANCE_CONNECTION }}
  DB_PROXY_PORT: ${{ vars.DB_PROXY_PORT || '5432' }}

jobs:
  migrate-dev:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LOGITRACK_SA_KEY }}
          service_account: ${{ vars.LOGITRACK_SA }}
      - name: Start Cloud SQL Proxy (dev)
        run: |
          if [ -z "${CLOUDSQL_INSTANCE_CONNECTION}" ]; then
            echo "CLOUDSQL_INSTANCE_CONNECTION is required for PR migrations" >&2
            exit 1
          fi
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.11.4/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy "${CLOUDSQL_INSTANCE_CONNECTION}" --port "${DB_PROXY_PORT}" > proxy-dev.log 2>&1 &
          sleep 3
      - name: Verify Cloud SQL Proxy (dev)
        run: |
          for i in $(seq 1 10); do
            if (echo > /dev/tcp/127.0.0.1/${DB_PROXY_PORT}) >/dev/null 2>&1; then
              echo "Cloud SQL Proxy is accepting connections on ${DB_PROXY_PORT}"
              exit 0
            fi
            echo "Waiting for Cloud SQL Proxy..."
            sleep 2
          done
          if [ -f proxy-dev.log ]; then
            echo "--- Cloud SQL Proxy (dev) log ---"
            cat proxy-dev.log
          fi
          echo "Cloud SQL Proxy did not become ready" >&2
          exit 1
      - name: Check DB connectivity (dev)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL_DEV secret is required for PR migrations" >&2
            exit 1
          fi
          python3 - <<'PY'
          import os
          import sys
          import urllib.parse
          url = os.environ.get("DATABASE_URL", "")
          if url.count("@") > 1:
            print("DATABASE_URL appears to contain an unencoded '@' in the password. URL-encode it.")
            sys.exit(1)
          parsed = urllib.parse.urlparse(url)
          userinfo = parsed.netloc.split("@")[0] if "@" in parsed.netloc else ""
          user, _, password = userinfo.partition(":")
          allowed = set("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~%")
          def bad(value):
            return any(ch not in allowed for ch in value)
          if bad(user) or bad(password):
            print("DATABASE_URL contains unencoded special characters. URL-encode username/password.")
            sys.exit(1)
          PY
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          DB_URL_NO_SCHEMA="${DATABASE_URL%\?schema=public}"
          for i in $(seq 1 5); do
            if psql "${DB_URL_NO_SCHEMA}" -c "SELECT 1;" >/dev/null 2>&1; then
              echo "Database connection successful."
              exit 0
            fi
            echo "Waiting for database connection..."
            sleep 2
          done
          psql "${DB_URL_NO_SCHEMA}" -c "SELECT 1;"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Run Prisma migrations (dev)
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL_DEV secret is required for PR migrations" >&2
            exit 1
          fi
          if [ -z "${CLOUDSQL_INSTANCE_CONNECTION}" ]; then
            echo "CLOUDSQL_INSTANCE_CONNECTION is required for PR migrations" >&2
            exit 1
          fi
          npm install
          npx prisma generate
          npx prisma migrate deploy

  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install Dependencies
        run: npm ci
        working-directory: frontend
      - name: Lint
        run: npm run lint --if-present
        working-directory: frontend
      - name: Format
        run: npm run format --if-present
        working-directory: frontend

  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install Dependencies
        run: npm install
        working-directory: backend
      - name: Lint
        run: npm run lint --if-present
        working-directory: backend
      - name: Format
        run: npm run format --if-present
        working-directory: backend

  build-push-deploy-backend:
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install Dependencies
        run: npm install
        working-directory: backend

      - name: Test
        run: npm test --if-present
        working-directory: backend

      - name: Start Cloud SQL Proxy (prod)
        env:
          CLOUDSQL_INSTANCE_CONNECTION: ${{ env.CLOUDSQL_INSTANCE_CONNECTION }}
          DB_PROXY_PORT: ${{ env.DB_PROXY_PORT }}
        run: |
          if [ -z "${CLOUDSQL_INSTANCE_CONNECTION}" ]; then
            echo "CLOUDSQL_INSTANCE_CONNECTION is required for prod migrations" >&2
            exit 1
          fi
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.11.4/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy "${CLOUDSQL_INSTANCE_CONNECTION}" --port "${DB_PROXY_PORT}" > proxy-prod.log 2>&1 &
          sleep 3
      - name: Verify Cloud SQL Proxy (prod)
        run: |
          for i in $(seq 1 10); do
            if (echo > /dev/tcp/127.0.0.1/${DB_PROXY_PORT}) >/dev/null 2>&1; then
              echo "Cloud SQL Proxy is accepting connections on ${DB_PROXY_PORT}"
              exit 0
            fi
            echo "Waiting for Cloud SQL Proxy..."
            sleep 2
          done
          if [ -f proxy-prod.log ]; then
            echo "--- Cloud SQL Proxy (prod) log ---"
            cat proxy-prod.log
          fi
          echo "Cloud SQL Proxy did not become ready" >&2
          exit 1
      - name: Check DB connectivity (prod)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL_PROD secret is required for prod migrations" >&2
            exit 1
          fi
          python3 - <<'PY'
          import os
          import sys
          import urllib.parse
          url = os.environ.get("DATABASE_URL", "")
          if url.count("@") > 1:
            print("DATABASE_URL appears to contain an unencoded '@' in the password. URL-encode it.")
            sys.exit(1)
          parsed = urllib.parse.urlparse(url)
          userinfo = parsed.netloc.split("@")[0] if "@" in parsed.netloc else ""
          user, _, password = userinfo.partition(":")
          allowed = set("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~%")
          def bad(value):
            return any(ch not in allowed for ch in value)
          if bad(user) or bad(password):
            print("DATABASE_URL contains unencoded special characters. URL-encode username/password.")
            sys.exit(1)
          PY
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          DB_URL_NO_SCHEMA="${DATABASE_URL%\?schema=public}"
          for i in $(seq 1 5); do
            if psql "${DB_URL_NO_SCHEMA}" -c "SELECT 1;" >/dev/null 2>&1; then
              echo "Database connection successful."
              exit 0
            fi
            echo "Waiting for database connection..."
            sleep 2
          done
          psql "${DB_URL_NO_SCHEMA}" -c "SELECT 1;"

      - name: Run Prisma migrations (prod)
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL_PROD secret is required for prod migrations" >&2
            exit 1
          fi
          if [ -z "${CLOUDSQL_INSTANCE_CONNECTION}" ]; then
            echo "CLOUDSQL_INSTANCE_CONNECTION is required for prod migrations" >&2
            exit 1
          fi
          npm install
          npx prisma generate
          npx prisma migrate deploy

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LOGITRACK_SA_KEY }}
          service_account: ${{ vars.LOGITRACK_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for GAR
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Ensure GAR repository
        run: |
          if ! gcloud artifacts repositories describe "${GAR_REPOSITORY}" --location "${REGION}" >/dev/null 2>&1; then
            gcloud artifacts repositories create "${GAR_REPOSITORY}" \
              --location "${REGION}" \
              --repository-format docker \
              --description "Docker repository for LogiTrack"
          fi

      - name: Build and Push Backend Image
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPOSITORY}/${IMAGE_NAME_BACKEND}:${GITHUB_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV
          docker build -t "${IMAGE_URI}" ./backend
          docker push "${IMAGE_URI}"

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy "${BACKEND_SERVICE_NAME}" \
            --image "${IMAGE_URI}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --platform managed \
            --service-account "${LOGITRACK_SA}" \
            --port 8080 \
            --set-env-vars "CORS_ORIGIN=${CORS_ORIGIN},CONFIG_BUCKET=${CONFIG_BUCKET}" \
            --allow-unauthenticated

  build-push-deploy-backend-dev:
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-backend, migrate-dev]
    if: github.event_name == 'pull_request'
    outputs:
      backend_url: ${{ steps.capture-backend-url.outputs.backend_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Validate dev deployment config
        run: |
          if [ -z "${BACKEND_SERVICE_NAME_DEV}" ]; then
            echo "CLOUD_RUN_SERVICE_DEV is required for PR deployments" >&2
            exit 1
          fi
          if [ -z "${CORS_ORIGIN_DEV}" ]; then
            echo "CORS_ORIGIN_DEV is required for PR deployments" >&2
            exit 1
          fi

      - name: Install Dependencies
        run: npm install
        working-directory: backend

      - name: Test
        run: npm test --if-present
        working-directory: backend

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LOGITRACK_SA_KEY }}
          service_account: ${{ vars.LOGITRACK_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for GAR
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Ensure GAR repository
        run: |
          if ! gcloud artifacts repositories describe "${GAR_REPOSITORY}" --location "${REGION}" >/dev/null 2>&1; then
            gcloud artifacts repositories create "${GAR_REPOSITORY}" \
              --location "${REGION}" \
              --repository-format docker \
              --description "Docker repository for LogiTrack"
          fi

      - name: Build and Push Backend Image
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPOSITORY}/${IMAGE_NAME_BACKEND}:${GITHUB_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV
          docker build -t "${IMAGE_URI}" ./backend
          docker push "${IMAGE_URI}"

      - name: Deploy Backend to Cloud Run (dev)
        run: |
          gcloud run deploy "${BACKEND_SERVICE_NAME_DEV}" \
            --image "${IMAGE_URI}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --platform managed \
            --service-account "${LOGITRACK_SA}" \
            --port 8080 \
            --set-env-vars "CORS_ORIGIN=${CORS_ORIGIN_DEV},CONFIG_BUCKET=${CONFIG_BUCKET_DEV}" \
            --allow-unauthenticated

      - name: Capture Backend URL (dev)
        id: capture-backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe "${BACKEND_SERVICE_NAME_DEV}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --format='value(status.url)')
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT

  build-deploy-frontend:
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install Dependencies
        run: npm ci
        working-directory: frontend

      - name: Build
        run: npm run build
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ env.FRONTEND_API_BASE_URL }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LOGITRACK_SA_KEY }}
          service_account: ${{ vars.LOGITRACK_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload Frontend to GCS
        if: env.FRONTEND_BUCKET != ''
        run: |
          gsutil -m rsync -r -d frontend/dist "gs://${FRONTEND_BUCKET}"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" "gs://${FRONTEND_BUCKET}/assets/**" || true
          gsutil -m setmeta -h "Cache-Control:no-cache, max-age=0" "gs://${FRONTEND_BUCKET}/index.html" "gs://${FRONTEND_BUCKET}/config.json" || true

  build-deploy-frontend-dev:
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-backend, migrate-dev, build-push-deploy-backend-dev]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Validate dev frontend config
        run: |
          if [ -z "${FRONTEND_BUCKET_DEV}" ]; then
            echo "FRONTEND_BUCKET_DEV is required for PR deployments" >&2
            exit 1
          fi
          if [ -z "${{ needs.build-push-deploy-backend-dev.outputs.backend_url }}" ]; then
            echo "Backend URL is required for PR frontend build" >&2
            exit 1
          fi

      - name: Install Dependencies
        run: npm ci
        working-directory: frontend

      - name: Build
        run: npm run build
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ needs.build-push-deploy-backend-dev.outputs.backend_url }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LOGITRACK_SA_KEY }}
          service_account: ${{ vars.LOGITRACK_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload Frontend to GCS (dev)
        run: |
          gsutil -m rsync -r -d frontend/dist "gs://${FRONTEND_BUCKET_DEV}"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" "gs://${FRONTEND_BUCKET_DEV}/assets/**" || true
          gsutil -m setmeta -h "Cache-Control:no-cache, max-age=0" "gs://${FRONTEND_BUCKET_DEV}/index.html" "gs://${FRONTEND_BUCKET_DEV}/config.json" || true
