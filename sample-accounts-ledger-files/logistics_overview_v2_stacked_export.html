<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Logistics Multi-View Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      padding: 14px 24px;
      background: #020617;
      border-bottom: 1px solid #1e293b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    header span {
      font-size: 12px;
      color: #94a3b8;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 11px;
      color: #9ca3af;
      background: #020617;
    }
    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .container {
      padding: 16px 20px 40px;
    }

    .panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 14px 16px;
      margin-bottom: 16px;
    }
    .panel-header {
      margin-bottom: 10px;
    }
    .panel-header h2 {
      font-size: 14px;
      margin: 0;
      font-weight: 600;
    }
    .panel-header span {
      font-size: 11px;
      color: #6b7280;
    }

    label {
      font-size: 11px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"],
    input[type="date"],
    select {
      width: 100%;
      box-sizing: border-box;
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 9px;
      font-size: 11px;
      margin-bottom: 8px;
    }
    input[type="file"] { padding: 4px 0; }
    button {
      background: linear-gradient(to right, #22c55e, #14b8a6);
      border: none;
      color: #020617;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .upload-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .upload-row > div {
      min-width: 200px;
      flex: 1;
    }

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #1f2937;
      margin-bottom: 12px;
    }
    .tab-btn {
      padding: 6px 12px;
      border-radius: 999px 999px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #020617;
      color: #e5e7eb;
      border-color: #1f2937;
      border-bottom: 1px solid #020617;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .filters-row > div {
      min-width: 160px;
      flex: 1;
    }

    .card-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .card h3 {
      margin: 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }
    .card .value {
      margin-top: 6px;
      font-size: 18px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .card .value-alert { color: #ef4444 !important; }
    .card .sub {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
    }
    .card .sub-alert { color: #fca5a5 !important; }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #020617;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      border-bottom: 1px solid #111827;
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }
    tbody tr:nth-child(even) { background: #020617; }
    tbody tr:nth-child(odd) { background: #020617; }
    h3.table-title {
      font-size: 12px;
      margin: 10px 0 6px;
    }


    .table-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin: 4px 0 6px;
    }

    .tables-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
      margin-top: 4px;
    }
    @media (max-width: 900px) {
      .tables-row { grid-template-columns: 1fr; }
    }

    footer {
      padding: 8px 20px 12px;
      background: #020617;
      border-top: 1px solid #1e293b;
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }

    .muted {
      font-size: 11px;
      color: #6b7280;
    }

    @media (max-width: 800px) {
      .upload-row { flex-direction: column; }
    }

    @media print {
      :root { color-scheme: light; }
      body { background: #ffffff; color: #000000; }
      header, .upload-row, .tabs, footer { display:none !important; }
      .container { padding: 0; }
      .panel { border: 1px solid #cccccc; box-shadow: none; background: #ffffff; }
      .card { border-color: #cccccc; background: #ffffff; box-shadow: none; }
      .table-wrapper { max-height: none; }
      table { font-size: 10px; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Logistics Multi-View Dashboard</h1>
    <span>Summary • Customer • Royalty • Transport • Quarry</span>
  </div>
  <div class="badge">
    <span class="badge-dot"></span>
    <span>Upload data → see summary → drill into tabs</span>
  </div>
</header>

<div class="container">
  <!-- Upload Panel -->
  <div class="panel">
    <div class="panel-header">
      <h2>Data Upload</h2>
      <span>Trips JSON + Accounts JSON</span>
    </div>
    <div class="upload-row">
      <div>
        <label for="tripsFile">Trips JSON</label>
        <input type="file" id="tripsFile" accept=".json" />
      </div>
      <div>
        <label for="accountsFile">Accounts JSON</label>
        <input type="file" id="accountsFile" accept=".json" />
      </div>
      <div style="align-self:flex-end;">
        <button id="loadBtn" disabled>Process Data</button>
      </div>
    </div>
    <p class="muted">Trips rows without any Customer / Site / Transport / Royalty / Quarry are ignored.</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="summary">Summary</button>
    <button class="tab-btn" data-tab="customer">Customer</button>
    <button class="tab-btn" data-tab="royalty">Royalty</button>
    <button class="tab-btn" data-tab="transport">Transport</button>
    <button class="tab-btn" data-tab="quarry">Quarry</button>
  </div>

  <!-- SUMMARY TAB -->
  <div id="tab-summary" class="tab-panel active">
    <div class="panel">
      <div class="panel-header">
        <h2>Outstanding Summary</h2>
        <span>All customers & vendors – receivable / payable</span>
      </div>
      <div class="table-actions">
        <button type="button" onclick="exportTableToCSV('summaryTable','summary_outstanding.csv')">Export Excel</button>
        <button type="button" onclick="exportTableToPDF('summaryTable','Outstanding Summary')">Export PDF</button>
      </div>
      <div class="table-wrapper">
        <table id="summaryTable">
          <thead>
          <tr>
            <th>S. No.</th>
            <th>Name</th>
            <th>Type</th>
            <th>Outstanding Amount</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">Positive = payable by you · Negative (red) = receivable by you (follow up).</p>
    </div>
  </div>

  <!-- CUSTOMER TAB -->
  <div id="tab-customer" class="tab-panel">
    <div class="panel">
      <div class="panel-header">
        <h2>Customer View</h2>
        <span>Billable / receivable per customer</span>
      </div>
      <div class="filters-row">
        <div>
          <label for="custDateFrom">Date From</label>
          <input type="date" id="custDateFrom">
        </div>
        <div>
          <label for="custDateTo">Date To</label>
          <input type="date" id="custDateTo">
        </div>
        <div>
          <label for="custCustomer">Customer (Company)</label>
          <select id="custCustomer" disabled>
            <option value="">All Customers</option>
          </select>
        </div>
        <div>
          <label for="custSite">Location (Site)</label>
          <select id="custSite" disabled>
            <option value="">All Sites</option>
          </select>
        </div>
      </div>
      <div class="card-row" id="custKpis"></div>

      <div class="tables-row">
        <div>
          <h3 class="table-title">Customer Trips</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('custTripsTable','customer_trips.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('custTripsTable','Customer Trips')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="custTripsTable">
              <thead>
              <tr>
                <th>DC Date</th>
                <th>DC No</th>
                <th>Customer</th>
                <th>Site</th>
                <th>Transport</th>
                <th>10K-1T</th>
                <th>1T-3T</th>
                <th>Total Bill</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="table-title">Customer Accounts</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('custAccTable','customer_accounts.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('custAccTable','Customer Accounts')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="custAccTable">
              <thead>
              <tr>
                <th>Date</th>
                <th>From</th>
                <th>Via</th>
                <th>To</th>
                <th>To Bank</th>
                <th>Amount</th>
                <th>Payment Type</th>
                <th>Payment Sub-Type</th>
                <th>Category</th>
                <th>Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ROYALTY TAB -->
  <div id="tab-royalty" class="tab-panel">
    <div class="panel">
      <div class="panel-header">
        <h2>Royalty View</h2>
        <span>Royalty M3 / amounts per royalty owner</span>
      </div>
      <div class="filters-row">
        <div>
          <label for="royDateFrom">Date From</label>
          <input type="date" id="royDateFrom">
        </div>
        <div>
          <label for="royDateTo">Date To</label>
          <input type="date" id="royDateTo">
        </div>
        <div>
          <label for="royOwner">Royalty Owner</label>
          <select id="royOwner" disabled>
            <option value="">All Royalty Owners</option>
          </select>
        </div>
        <div>
          <label for="roySite">Location (Site)</label>
          <select id="roySite" disabled>
            <option value="">All Sites</option>
          </select>
        </div>
      </div>
      <div class="card-row" id="royKpis"></div>

      <div class="tables-row">
        <div>
          <h3 class="table-title">Royalty Trips</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('royTripsTable','royalty_trips.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('royTripsTable','Royalty Trips')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="royTripsTable">
              <thead>
              <tr>
                <th>DC Date</th>
                <th>DC No</th>
                <th>Royalty Owner</th>
                <th>Site</th>
                <th>Royalty M3</th>
                <th>Royalty Amount</th>
                <th>Total Bill</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="table-title">Royalty Accounts</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('royAccTable','royalty_accounts.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('royAccTable','Royalty Accounts')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="royAccTable">
              <thead>
              <tr>
                <th>Date</th>
                <th>From</th>
                <th>Via</th>
                <th>To</th>
                <th>To Bank</th>
                <th>Amount</th>
                <th>Payment Type</th>
                <th>Payment Sub-Type</th>
                <th>Category</th>
                <th>Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- TRANSPORT TAB -->
  <div id="tab-transport" class="tab-panel">
    <div class="panel">
      <div class="panel-header">
        <h2>Transport View</h2>
        <span>Trips and payable per transport vendor</span>
      </div>
      <div class="filters-row">
        <div>
          <label for="trnDateFrom">Date From</label>
          <input type="date" id="trnDateFrom">
        </div>
        <div>
          <label for="trnDateTo">Date To</label>
          <input type="date" id="trnDateTo">
        </div>
        <div>
          <label for="trnTransport">Transporter</label>
          <select id="trnTransport" disabled>
            <option value="">All Transporters</option>
          </select>
        </div>
        <div>
          <label for="trnSite">Location (Site)</label>
          <select id="trnSite" disabled>
            <option value="">All Sites</option>
          </select>
        </div>
      </div>
      <div class="card-row" id="trnKpis"></div>

      <div class="tables-row">
        <div>
          <h3 class="table-title">Transport Trips</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('trnTripsTable','transport_trips.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('trnTripsTable','Transport Trips')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="trnTripsTable">
              <thead>
              <tr>
                <th>DC Date</th>
                <th>DC No</th>
                <th>Vehicle No</th>
                <th>10K-1T</th>
                <th>1T-3T</th>
                <th>Transport Rate</th>
                <th>TrAmount</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="table-title">Transport Accounts</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('trnAccTable','transport_accounts.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('trnAccTable','Transport Accounts')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="trnAccTable">
              <thead>
              <tr>
                <th>Date</th>
                <th>From</th>
                <th>Via</th>
                <th>To</th>
                <th>To Bank</th>
                <th>Amount</th>
                <th>Payment Type</th>
                <th>Payment Sub-Type</th>
                <th>Category</th>
                <th>Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- QUARRY TAB -->
  <div id="tab-quarry" class="tab-panel">
    <div class="panel">
      <div class="panel-header">
        <h2>Quarry View</h2>
        <span>Trips and payable per quarry</span>
      </div>
      <div class="filters-row">
        <div>
          <label for="qryDateFrom">Date From</label>
          <input type="date" id="qryDateFrom">
        </div>
        <div>
          <label for="qryDateTo">Date To</label>
          <input type="date" id="qryDateTo">
        </div>
        <div>
          <label for="qryQuarry">Quarry</label>
          <select id="qryQuarry" disabled>
            <option value="">All Quarries</option>
          </select>
        </div>
        <div>
          <label for="qrySite">Location (Site)</label>
          <select id="qrySite" disabled>
            <option value="">All Sites</option>
          </select>
        </div>
      </div>
      <div class="card-row" id="qryKpis"></div>

      <div class="tables-row">
        <div>
          <h3 class="table-title">Quarry Trips</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('qryTripsTable','quarry_trips.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('qryTripsTable','Quarry Trips')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="qryTripsTable">
              <thead>
              <tr>
                <th>DC Date</th>
                <th>DC No</th>
                <th>Vehicle No</th>
                <th>10K-1T</th>
                <th>1T-3T</th>
                <th>Deduction %</th>
                <th>Size Change %</th>
                <th>Deduction Qty</th>
                <th>Size Change Qty (+10K-1T)</th>
                <th>Net 10K-1T</th>
                <th>Net 1T-3T</th>
                <th>Quarry Rate</th>
                <th>Quarry Amount</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="table-title">Quarry Accounts</h3>
          <div class="table-actions">
            <button type="button" onclick="exportTableToCSV('qryAccTable','quarry_accounts.csv')">Export Excel</button>
            <button type="button" onclick="exportTableToPDF('qryAccTable','Quarry Accounts')">Export PDF</button>
          </div>
          <div class="table-wrapper">
            <table id="qryAccTable">
              <thead>
              <tr>
                <th>Date</th>
                <th>From</th>
                <th>Via</th>
                <th>To</th>
                <th>To Bank</th>
                <th>Amount</th>
                <th>Payment Type</th>
                <th>Payment Sub-Type</th>
                <th>Category</th>
                <th>Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<footer>
  Logistics Multi-View Dashboard • Designed for role-specific statements
</footer>

<script>
  let tripsData = [];
  let accountsData = [];

  const tripsFileInput = document.getElementById('tripsFile');
  const accountsFileInput = document.getElementById('accountsFile');
  const loadBtn = document.getElementById('loadBtn');

  function isFileReady() {
    return tripsFileInput.files.length > 0 && accountsFileInput.files.length > 0;
  }
  function updateLoadButtonState() {
    loadBtn.disabled = !isFileReady();
  }
  tripsFileInput.addEventListener('change', updateLoadButtonState);
  accountsFileInput.addEventListener('change', updateLoadButtonState);

  loadBtn.addEventListener('click', () => {
    if (!isFileReady()) return;
    Promise.all([
      readJsonFile(tripsFileInput.files[0]),
      readJsonFile(accountsFileInput.files[0])
    ]).then(([tripsJson, accountsJson]) => {
      const rawTrips = normalizeArray(tripsJson);
      tripsData = rawTrips.filter(r => {
        const c = safeString(r['Company']);
        const s = safeString(r['Site']);
        const t = safeString(r['Transport']);
        const ro = safeString(r['Royalty Owner']);
        const q = safeString(r['Quarry']);
        return (c || s || t || ro || q);
      });
      accountsData = normalizeArray(accountsJson);
      buildOptions();
      enableFilters();
      renderAllTabs();
    }).catch(err => {
      console.error(err);
      alert('Error reading JSON files. Check console.');
    });
  });

  function readJsonFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try { resolve(JSON.parse(e.target.result)); }
        catch (err) { reject(err); }
      };
      reader.onerror = reject;
      reader.readAsText(file);
    });
  }
  function normalizeArray(json) {
    if (Array.isArray(json)) return json;
    const firstKey = Object.keys(json)[0];
    if (Array.isArray(json[firstKey])) return json[firstKey];
    return [];
  }
  function safeString(v) {
    return (v === null || v === undefined) ? '' : String(v).trim();
  }
  function safeNumber(v) {
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function parseDDMMYYYY(s) {
    s = safeString(s);
    if (!s) return null;
    const sep = s.includes('-') ? '-' : (s.includes('/') ? '/' : null);
    if (!sep) return null;
    const parts = s.split(sep);
    if (parts.length !== 3) return null;
    let [dd, mm, yy] = parts;
    let d = parseInt(dd, 10);
    let m = parseInt(mm, 10);
    let y = parseInt(yy, 10);
    if (!d || !m || !y) return null;
    if (y < 100) y = 2000 + y;
    return new Date(y, m - 1, d);
  }
  function matchDate(ddmmyyyy, fromDate, toDate) {
    if (!fromDate && !toDate) return true;
    const d = parseDDMMYYYY(ddmmyyyy);
    if (!d) return true;
    if (fromDate && d < fromDate) return false;
    if (toDate && d > toDate) return false;
    return true;
  }

  // Build filter options
  function buildOptions() {
    const customers = new Set();
    const royaltyOwners = new Set();
    const transports = new Set();
    const quarries = new Set();
    const sites = new Set();

    tripsData.forEach(r => {
      const c = safeString(r['Company']); if (c) customers.add(c);
      const ro = safeString(r['Royalty Owner']); if (ro) royaltyOwners.add(ro);
      const t = safeString(r['Transport']); if (t) transports.add(t);
      const q = safeString(r['Quarry']); if (q) quarries.add(q);
      const s = safeString(r['Site']); if (s) sites.add(s);
    });

    fillSelect('custCustomer', customers, 'All Customers');
    fillSelect('custSite', sites, 'All Sites');
    fillSelect('royOwner', royaltyOwners, 'All Royalty Owners');
    fillSelect('roySite', sites, 'All Sites');
    fillSelect('trnTransport', transports, 'All Transporters');
    fillSelect('trnSite', sites, 'All Sites');
    fillSelect('qryQuarry', quarries, 'All Quarries');
    fillSelect('qrySite', sites, 'All Sites');
  }

  function fillSelect(id, valuesSet, defaultLabel) {
    const selectEl = document.getElementById(id);
    const prev = selectEl.value;
    selectEl.innerHTML = `<option value="">${defaultLabel}</option>`;
    Array.from(valuesSet).sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
    if (prev && Array.from(selectEl.options).some(o => o.value === prev)) {
      selectEl.value = prev;
    }
  }

  function enableFilters() {
    ['custCustomer','custSite','royOwner','roySite','trnTransport','trnSite','qryQuarry','qrySite']
      .forEach(id => document.getElementById(id).disabled = false);
  }

  // Tabs switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      renderAllTabs();
    });
  });

  // Filter change listeners
  [
    'custDateFrom','custDateTo','custCustomer','custSite',
    'royDateFrom','royDateTo','royOwner','roySite',
    'trnDateFrom','trnDateTo','trnTransport','trnSite',
    'qryDateFrom','qryDateTo','qryQuarry','qrySite'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', renderAllTabs);
  });

  function renderAllTabs() {
    if (!tripsData.length) return;
    renderSummaryTab();
    renderCustomerTab();
    renderRoyaltyTab();
    renderTransportTab();
    renderQuarryTab();
  }

  // ---------- SUMMARY TAB ----------
  function renderSummaryTab() {
    const tbody = document.querySelector('#summaryTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const rows = [];

    // CUSTOMERS
    const customerSet = new Set();
    tripsData.forEach(r => { const c = safeString(r['Company']); if (c) customerSet.add(c); });
    accountsData.forEach(r => { const f = safeString(r['FROM']); if (f) customerSet.add(f); });

    customerSet.forEach(name => {
      const billable = tripsData.reduce((s,r)=> s + (safeString(r['Company'])===name ? safeNumber(r['Total Bill']) : 0),0);
      const received = accountsData.reduce((s,r)=> s + (safeString(r['FROM'])===name ? safeNumber(r['AMOUNT']) : 0),0);
      const outstanding = received - billable; // + payable, - receivable
      if (Math.abs(outstanding) > 0.5) {
        rows.push({name, type:'Customer', outstanding});
      }
    });

    // TRANSPORT
    const transportSet = new Set();
    tripsData.forEach(r=>{ const t=safeString(r['Transport']); if(t) transportSet.add(t); });
    accountsData.forEach(r=>{ const t=safeString(r['TO']); if(t) transportSet.add(t); });

    transportSet.forEach(name=>{
      const billable = tripsData.reduce((s,r)=> s + (safeString(r['Transport'])===name ? safeNumber(r['TrAmount']) : 0),0);
      const paid = accountsData.reduce((s,r)=> s + (safeString(r['TO'])===name ? safeNumber(r['AMOUNT']) : 0),0);
      const outstanding = billable - paid;
      if (Math.abs(outstanding) > 0.5) {
        rows.push({name, type:'Transport', outstanding});
      }
    });

    // ROYALTY
    const royaltySet = new Set();
    tripsData.forEach(r=>{ const ro=safeString(r['Royalty Owner']); if(ro) royaltySet.add(ro); });
    accountsData.forEach(r=>{ const t=safeString(r['TO']); if(t && royaltySet.has(t)) royaltySet.add(t); });

    royaltySet.forEach(name=>{
      const billable = tripsData.reduce((s,r)=> s + (safeString(r['Royalty Owner'])===name ? safeNumber(r['Royalty Amount payable']||r['Royalty Amount']) : 0),0);
      const paid = accountsData.reduce((s,r)=> s + (safeString(r['TO'])===name ? safeNumber(r['AMOUNT']) : 0),0);
      const outstanding = billable - paid;
      if (Math.abs(outstanding) > 0.5) {
        rows.push({name, type:'Royalty', outstanding});
      }
    });

    // QUARRY
    const quarrySet = new Set();
    tripsData.forEach(r=>{ const q=safeString(r['Quarry']); if(q) quarrySet.add(q); });
    accountsData.forEach(r=>{ const t=safeString(r['TO']); if(t && quarrySet.has(t)) quarrySet.add(t); });

    quarrySet.forEach(name=>{
      const billable = tripsData.reduce((s,r)=> s + (safeString(r['Quarry'])===name ? safeNumber(r['QuarryAmount']) : 0),0);
      const paid = accountsData.reduce((s,r)=> s + (safeString(r['TO'])===name ? safeNumber(r['AMOUNT']) : 0),0);
      const outstanding = billable - paid;
      if (Math.abs(outstanding) > 0.5) {
        rows.push({name, type:'Quarry', outstanding});
      }
    });

    // Sort by absolute outstanding desc
    rows.sort((a,b)=> Math.abs(b.outstanding) - Math.abs(a.outstanding));

    rows.forEach((row, idx)=>{
      const tr = document.createElement('tr');
      const status = row.outstanding > 0 ? 'Payable' : (row.outstanding < 0 ? 'Receivable' : 'Settled');
      const isReceivable = row.outstanding < 0;
      const amtText = '₹ ' + row.outstanding.toFixed(0);
      const tdIdx = document.createElement('td'); tdIdx.textContent = idx+1;
      const tdName = document.createElement('td'); tdName.textContent = row.name;
      const tdType = document.createElement('td'); tdType.textContent = row.type;
      const tdAmt = document.createElement('td'); tdAmt.textContent = amtText;
      const tdStatus = document.createElement('td'); tdStatus.textContent = status;
      if (isReceivable) {
        tdAmt.style.color = '#ef4444';
        tdStatus.style.color = '#ef4444';
      }
      tr.appendChild(tdIdx);
      tr.appendChild(tdName);
      tr.appendChild(tdType);
      tr.appendChild(tdAmt);
      tr.appendChild(tdStatus);
      tbody.appendChild(tr);
    });
  }

  // ---------- CUSTOMER TAB ----------
  function getCustomerContext() {
    const from = document.getElementById('custDateFrom').value;
    const to = document.getElementById('custDateTo').value;
    const customer = safeString(document.getElementById('custCustomer').value);
    const site = safeString(document.getElementById('custSite').value);
    return {
      fromDate: from ? new Date(from) : null,
      toDate: to ? new Date(to) : null,
      customer, site
    };
  }
  function filterCustomerTrips(ctx) {
    return tripsData.filter(r => {
      const dcDate = safeString(r['DC Date']);
      if (!matchDate(dcDate, ctx.fromDate, ctx.toDate)) return false;
      if (ctx.customer && safeString(r['Company']) !== ctx.customer) return false;
      if (ctx.site && safeString(r['Site']) !== ctx.site) return false;
      return true;
    });
  }
  function filterCustomerAccounts(ctx) {
    if (!ctx.customer) return [];
    return accountsData.filter(r => {
      const adate = safeString(r['DATE']);
      if (!matchDate(adate, ctx.fromDate, ctx.toDate)) return false;
      return safeString(r['FROM']) === ctx.customer;
    });
  }
  function renderCustomerTab() {
    const ctx = getCustomerContext();
    const trips = filterCustomerTrips(ctx);
    const accounts = filterCustomerAccounts(ctx);

    const totalTrips = trips.length;
    const totalTon = trips.reduce((s,r)=> s + safeNumber(r['10K-1T']) + safeNumber(r['1T-3T']),0);
    const billable = trips.reduce((s,r)=> s + safeNumber(r['Total Bill']),0);
    const received = accounts.reduce((s,r)=> s + safeNumber(r['AMOUNT']),0);

    const outstanding = received - billable;

    const custKpis = document.getElementById('custKpis');
    custKpis.innerHTML = '';
    const customerLabel = ctx.customer || 'Select a customer for detailed statement';

    let outSuffix = '';
    let outSub = ctx.customer ? '' : 'Select a customer';
    let alertRed = false;
    if (ctx.customer) {
      if (outstanding < 0) {
        outSuffix = ' (Receivable)';
        outSub = 'Receivable from customer – follow up (risk if forgotten)';
        alertRed = true;
      } else if (outstanding > 0) {
        outSuffix = ' (Payable)';
        outSub = 'Advance / over-received from this customer';
      } else {
        outSub = 'Settled';
      }
    }

    const kpis = [
      {title:'Total Trips', value: totalTrips.toLocaleString('en-IN'), sub: customerLabel},
      {title:'Total Tonnage (10K-1T + 1T-3T)', value: totalTon.toFixed(2), sub:'Filtered Trips'},
      {title:'Total Billable Amount', value:'₹ '+billable.toFixed(0), sub:'Sum of Total Bill'},
      {title:'Total Received Amount', value:'₹ '+received.toFixed(0), sub: ctx.customer ? `FROM = ${ctx.customer}` : 'Select a customer to view receipts'},
      {
        title:'Total Outstanding' + outSuffix,
        value:'₹ '+outstanding.toFixed(0),
        sub: outSub,
        alertRed
      }
    ];
    kpis.forEach(k => {
      const card = document.createElement('div');
      card.className='card';
      const valueClass = k.alertRed ? 'value value-alert' : 'value';
      const subClass = k.alertRed ? 'sub sub-alert' : 'sub';
      card.innerHTML = `<h3>${k.title}</h3>
        <div class="${valueClass}">${k.value}</div>
        <div class="${subClass}">${k.sub}</div>`;
      custKpis.appendChild(card);
    });

    const tbody = document.querySelector('#custTripsTable tbody');
    tbody.innerHTML='';
    trips.forEach(r=>{
      const tr=document.createElement('tr');
      const cells=[
        safeString(r['DC Date']),
        safeString(r['DC Number'])||safeString(r['DC No']),
        safeString(r['Company']),
        safeString(r['Site']),
        safeString(r['Transport']),
        safeNumber(r['10K-1T']).toFixed(2),
        safeNumber(r['1T-3T']).toFixed(2),
        safeNumber(r['Total Bill']).toFixed(0)
      ];
      cells.forEach(c=>{
        const td=document.createElement('td');
        td.textContent=c==='NaN'?'':c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    const total10 = trips.reduce((s,r)=> s+safeNumber(r['10K-1T']),0);
    const total13 = trips.reduce((s,r)=> s+safeNumber(r['1T-3T']),0);
    const totalBill = billable;
    if(trips.length){
      const totalRow=document.createElement('tr');
      totalRow.style.fontWeight='600';
      for (let i=0;i<8;i++){
        const td=document.createElement('td');
        if(i===0) td.textContent='TOTAL';
        else if(i===5) td.textContent=total10.toFixed(2);
        else if(i===6) td.textContent=total13.toFixed(2);
        else if(i===7) td.textContent=totalBill.toFixed(0);
        else td.textContent='';
        totalRow.appendChild(td);
      }
      tbody.appendChild(totalRow);
    }

    renderAccountsTableFor(accounts, 'custAccTable');
  }

  // ---------- ROYALTY TAB ----------
  function getRoyaltyContext() {
    const from = document.getElementById('royDateFrom').value;
    const to = document.getElementById('royDateTo').value;
    const owner = safeString(document.getElementById('royOwner').value);
    const site = safeString(document.getElementById('roySite').value);
    return {fromDate: from?new Date(from):null, toDate: to?new Date(to):null, owner, site};
  }
  function filterRoyaltyTrips(ctx) {
    return tripsData.filter(r=>{
      const dcDate = safeString(r['DC Date']);
      if (!matchDate(dcDate, ctx.fromDate, ctx.toDate)) return false;
      if (ctx.owner && safeString(r['Royalty Owner'])!==ctx.owner) return false;
      if (ctx.site && safeString(r['Site'])!==ctx.site) return false;
      return true;
    });
  }
  function filterRoyaltyAccounts(ctx) {
    if (!ctx.owner) return [];
    return accountsData.filter(r=>{
      const adate = safeString(r['DATE']);
      if (!matchDate(adate, ctx.fromDate, ctx.toDate)) return false;
      return safeString(r['TO'])===ctx.owner;
    });
  }
  function renderRoyaltyTab() {
    const ctx = getRoyaltyContext();
    const trips = filterRoyaltyTrips(ctx);
    const accounts = filterRoyaltyAccounts(ctx);

    const totalTrips = trips.length;
    const royaltyM3 = trips.reduce((s,r)=>{
      const direct = safeNumber(r['Royalty M3']);
      const fallback = safeNumber(r['Total Considerable M3']||r['Actual M3']);
      return s + (direct || (!direct ? fallback : 0));
    },0);
    const royaltyAmt = trips.reduce((s,r)=> s + safeNumber(r['Royalty Amount payable']||r['Royalty Amount']),0);
    const paid = accounts.reduce((s,r)=> s + safeNumber(r['AMOUNT']),0);

    const outstanding = royaltyAmt - paid;

    const kpiRow = document.getElementById('royKpis');
    kpiRow.innerHTML='';
    const label = ctx.owner || 'Select a royalty owner';

    let outSuffix='', outSub = ctx.owner ? '' : 'Select a royalty owner', alertRed=false;
    if(ctx.owner){
      if(outstanding < 0){
        outSuffix=' (Receivable)';
        outSub='Receivable from royalty owner (overpaid)';
        alertRed=true;
      } else if(outstanding > 0){
        outSuffix=' (Payable)';
        outSub='You still have to pay this royalty owner';
      } else {
        outSub='Settled';
      }
    }

    const kpis = [
      {title:'Total Trips', value: totalTrips.toLocaleString('en-IN'), sub:label},
      {title:'Total Royalty M3', value: royaltyM3.toFixed(3), sub:'Approx from trip data'},
      {title:'Total Royalty Amount', value:'₹ '+royaltyAmt.toFixed(0), sub:'From Trips'},
      {title:'Total Paid Amount', value:'₹ '+paid.toFixed(0), sub: ctx.owner ? `TO = ${ctx.owner}` : 'Select a royalty owner'},
      {
        title:'Total Outstanding' + outSuffix,
        value:'₹ '+outstanding.toFixed(0),
        sub: outSub,
        alertRed
      }
    ];
    kpis.forEach(k=>{
      const card=document.createElement('div'); card.className='card';
      const vClass=k.alertRed?'value value-alert':'value';
      const sClass=k.alertRed?'sub sub-alert':'sub';
      card.innerHTML=`<h3>${k.title}</h3>
        <div class="${vClass}">${k.value}</div>
        <div class="${sClass}">${k.sub}</div>`;
      kpiRow.appendChild(card);
    });

    const tbody=document.querySelector('#royTripsTable tbody');
    tbody.innerHTML='';
    trips.forEach(r=>{
      const rm3 = safeNumber(r['Royalty M3']) || safeNumber(r['Total Considerable M3']||r['Actual M3']);
      const tr=document.createElement('tr');
      const cells=[
        safeString(r['DC Date']),
        safeString(r['DC Number'])||safeString(r['DC No']),
        safeString(r['Royalty Owner']),
        safeString(r['Site']),
        rm3.toFixed(3),
        safeNumber(r['Royalty Amount payable']||r['Royalty Amount']).toFixed(0),
        safeNumber(r['Total Bill']).toFixed(0)
      ];
      cells.forEach(c=>{
        const td=document.createElement('td'); td.textContent=c==='NaN'?'':c; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    const totalRm3 = royaltyM3;
    const totalRAmt = royaltyAmt;
    const totalBill = trips.reduce((s,r)=> s+safeNumber(r['Total Bill']),0);
    if(trips.length){
      const totalRow=document.createElement('tr');
      totalRow.style.fontWeight='600';
      for(let i=0;i<7;i++){
        const td=document.createElement('td');
        if(i===0) td.textContent='TOTAL';
        else if(i===4) td.textContent=totalRm3.toFixed(3);
        else if(i===5) td.textContent=totalRAmt.toFixed(0);
        else if(i===6) td.textContent=totalBill.toFixed(0);
        else td.textContent='';
        totalRow.appendChild(td);
      }
      tbody.appendChild(totalRow);
    }

    renderAccountsTableFor(accounts, 'royAccTable');
  }

  // ---------- TRANSPORT TAB ----------
  function getTransportContext() {
    const from = document.getElementById('trnDateFrom').value;
    const to = document.getElementById('trnDateTo').value;
    const trn = safeString(document.getElementById('trnTransport').value);
    const site = safeString(document.getElementById('trnSite').value);
    return {fromDate: from?new Date(from):null, toDate: to?new Date(to):null, trn, site};
  }
  function filterTransportTrips(ctx) {
    return tripsData.filter(r=>{
      const dcDate = safeString(r['DC Date']);
      if (!matchDate(dcDate, ctx.fromDate, ctx.toDate)) return false;
      if (ctx.trn && safeString(r['Transport'])!==ctx.trn) return false;
      if (ctx.site && safeString(r['Site'])!==ctx.site) return false;
      return true;
    });
  }
  function filterTransportAccounts(ctx) {
    if (!ctx.trn) return [];
    return accountsData.filter(r=>{
      const adate = safeString(r['DATE']);
      if (!matchDate(adate, ctx.fromDate, ctx.toDate)) return false;
      return safeString(r['TO'])===ctx.trn;
    });
  }
  function renderTransportTab() {
    const ctx=getTransportContext();
    const trips=filterTransportTrips(ctx);
    const accounts=filterTransportAccounts(ctx);

    const totalTrips=trips.length;
    const totalTon=trips.reduce((s,r)=>s+safeNumber(r['10K-1T'])+safeNumber(r['1T-3T']),0);
    const trPayable=trips.reduce((s,r)=>s+safeNumber(r['TrAmount']),0);
    const paid=accounts.reduce((s,r)=> s+safeNumber(r['AMOUNT']),0);

    const outstanding=trPayable-paid; // + payable, - receivable

    const kpiRow=document.getElementById('trnKpis');
    kpiRow.innerHTML='';
    const label=ctx.trn||'Select a transporter';

    let outSuffix='', outSub=ctx.trn?'':'Select a transporter', alertRed=false;
    if(ctx.trn){
      if(outstanding<0){
        outSuffix=' (Receivable)';
        outSub='Receivable from transporter (overpaid)';
        alertRed=true;
      } else if(outstanding>0){
        outSuffix=' (Payable)';
        outSub='You still have to pay this transporter';
      } else {
        outSub='Settled';
      }
    }

    const kpis=[
      {title:'Total Trips', value: totalTrips.toLocaleString('en-IN'), sub:label},
      {title:'Total Tonnage (10K-1T + 1T-3T)', value: totalTon.toFixed(2), sub:'Filtered Trips'},
      {title:'Total Transport Payable', value:'₹ '+trPayable.toFixed(0), sub:'From TrAmount'},
      {title:'Total Paid Amount', value:'₹ '+paid.toFixed(0), sub: ctx.trn ? `TO = ${ctx.trn}` : 'Select a transporter'},
      {
        title:'Total Outstanding' + outSuffix,
        value:'₹ '+outstanding.toFixed(0),
        sub: outSub,
        alertRed
      }
    ];
    kpis.forEach(k=>{
      const card=document.createElement('div'); card.className='card';
      const vClass=k.alertRed?'value value-alert':'value';
      const sClass=k.alertRed?'sub sub-alert':'sub';
      card.innerHTML=`<h3>${k.title}</h3>
        <div class="${vClass}">${k.value}</div>
        <div class="${sClass}">${k.sub}</div>`;
      kpiRow.appendChild(card);
    });

    const tbody=document.querySelector('#trnTripsTable tbody');
    tbody.innerHTML='';
    trips.forEach(r=>{
      const tr=document.createElement('tr');
      const cells=[
        safeString(r['DC Date']),
        safeString(r['DC Number'])||safeString(r['DC No']),
        safeString(r['Vehicle No']),
        safeNumber(r['10K-1T']).toFixed(2),
        safeNumber(r['1T-3T']).toFixed(2),
        safeNumber(r['Transport Rate']).toFixed(0),
        safeNumber(r['TrAmount']).toFixed(2)
      ];
      cells.forEach(c=>{
        const td=document.createElement('td'); td.textContent=c==='NaN'?'':c; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    const t10 = trips.reduce((s,r)=> s+safeNumber(r['10K-1T']),0);
    const t13 = trips.reduce((s,r)=> s+safeNumber(r['1T-3T']),0);
    const tAmt = trPayable;
    if(trips.length){
      const totalRow=document.createElement('tr');
      totalRow.style.fontWeight='600';
      for(let i=0;i<7;i++){
        const td=document.createElement('td');
        if(i===0) td.textContent='TOTAL';
        else if(i===3) td.textContent=t10.toFixed(2);
        else if(i===4) td.textContent=t13.toFixed(2);
        else if(i===6) td.textContent=tAmt.toFixed(2);
        else td.textContent='';
        totalRow.appendChild(td);
      }
      tbody.appendChild(totalRow);
    }

    renderAccountsTableFor(accounts, 'trnAccTable');
  }

  // ---------- QUARRY TAB ----------
  function getQuarryContext() {
    const from = document.getElementById('qryDateFrom').value;
    const to = document.getElementById('qryDateTo').value;
    const quarry = safeString(document.getElementById('qryQuarry').value);
    const site = safeString(document.getElementById('qrySite').value);
    return {fromDate: from?new Date(from):null, toDate: to?new Date(to):null, quarry, site};
  }
  function filterQuarryTrips(ctx) {
    return tripsData.filter(r=>{
      const dcDate=safeString(r['DC Date']);
      if (!matchDate(dcDate, ctx.fromDate, ctx.toDate)) return false;
      if (ctx.quarry && safeString(r['Quarry'])!==ctx.quarry) return false;
      if (ctx.site && safeString(r['Site'])!==ctx.site) return false;
      return true;
    });
  }
  function filterQuarryAccounts(ctx) {
    if (!ctx.quarry) return [];
    return accountsData.filter(r=>{
      const adate=safeString(r['DATE']);
      if (!matchDate(adate, ctx.fromDate, ctx.toDate)) return false;
      return safeString(r['TO'])===ctx.quarry;
    });
  }
  function renderQuarryTab() {
    const ctx=getQuarryContext();
    const trips=filterQuarryTrips(ctx);
    const accounts=filterQuarryAccounts(ctx);

    const totalTrips=trips.length;
    const totalTon=trips.reduce((s,r)=>s+safeNumber(r['10K-1T'])+safeNumber(r['1T-3T']),0);
    const quarryPayable=trips.reduce((s,r)=>s+safeNumber(r['QuarryAmount']),0);
    const paid=accounts.reduce((s,r)=> s+safeNumber(r['AMOUNT']),0);
    const deductedTon = trips.reduce((s,r)=> s+safeNumber(r['Deduction Qty']),0);
    const netTon = trips.reduce((s,r)=> s+safeNumber(r['Net 10K-1T'])+safeNumber(r['Net 1T-3T']),0);

    const outstanding=quarryPayable-paid;

    const kpiRow=document.getElementById('qryKpis');
    kpiRow.innerHTML='';
    const label=ctx.quarry||'Select a quarry';

    let outSuffix='', outSub=ctx.quarry?'':'Select a quarry', alertRed=false;
    if(ctx.quarry){
      if(outstanding<0){
        outSuffix=' (Receivable)';
        outSub='Receivable from quarry (overpaid)';
        alertRed=true;
      } else if(outstanding>0){
        outSuffix=' (Payable)';
        outSub='You still have to pay this quarry';
      } else {
        outSub='Settled';
      }
    }

    const kpis=[
      {title:'Total Trips', value: totalTrips.toLocaleString('en-IN'), sub:label},
      {title:'Total Tonnage (10K-1T + 1T-3T)', value: totalTon.toFixed(2), sub:'Before deductions'},
      {title:'Deducted Tonnage', value: deductedTon.toFixed(2), sub:'Loss due to deductions', alertRed:true},
      {title:'Net Tonnage', value: netTon.toFixed(2), sub:'Net 10K-1T + Net 1T-3T'},
      {title:'Total Quarry Payable', value:'₹ '+quarryPayable.toFixed(0), sub:'From QuarryAmount'},
      {title:'Total Paid Amount', value:'₹ '+paid.toFixed(0), sub: ctx.quarry ? `TO = ${ctx.quarry}` : 'Select a quarry'},
      {
        title:'Total Outstanding' + outSuffix,
        value:'₹ '+outstanding.toFixed(0),
        sub: outSub,
        alertRed
      }
    ];
    kpis.forEach(k=>{
      const card=document.createElement('div'); card.className='card';
      const vClass=k.alertRed?'value value-alert':'value';
      const sClass=k.alertRed?'sub sub-alert':'sub';
      card.innerHTML=`<h3>${k.title}</h3>
        <div class="${vClass}">${k.value}</div>
        <div class="${sClass}">${k.sub}</div>`;
      kpiRow.appendChild(card);
    });

    const tbody=document.querySelector('#qryTripsTable tbody');
    tbody.innerHTML='';
    trips.forEach(r=>{
      const tr=document.createElement('tr');
      const cells=[
        safeString(r['DC Date']),
        safeString(r['DC Number'])||safeString(r['DC No']),
        safeString(r['Vehicle No']),
        safeNumber(r['10K-1T']).toFixed(2),
        safeNumber(r['1T-3T']).toFixed(2),
        safeNumber(r['Deduction %']).toFixed(2),
        safeNumber(r['Size Change %']).toFixed(2),
        safeNumber(r['Deduction Qty']).toFixed(2),
        safeNumber(r['Size Change Qty (add to 10K-1T)']).toFixed(2),
        safeNumber(r['Net 10K-1T']).toFixed(2),
        safeNumber(r['Net 1T-3T']).toFixed(2),
        safeNumber(r['Boulder Rate']).toFixed(2),
        safeNumber(r['QuarryAmount']).toFixed(0)
      ];
      cells.forEach(c=>{
        const td=document.createElement('td'); td.textContent=c==='NaN'?'':c; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    const t10 = trips.reduce((s,r)=> s+safeNumber(r['10K-1T']),0);
    const t13 = trips.reduce((s,r)=> s+safeNumber(r['1T-3T']),0);
    const tDed = deductedTon;
    const tSz = trips.reduce((s,r)=> s+safeNumber(r['Size Change Qty (add to 10K-1T)']),0);
    const tNet10 = trips.reduce((s,r)=> s+safeNumber(r['Net 10K-1T']),0);
    const tNet13 = trips.reduce((s,r)=> s+safeNumber(r['Net 1T-3T']),0);
    const tQ = quarryPayable;
    if(trips.length){
      const totalRow=document.createElement('tr');
      totalRow.style.fontWeight='600';
      for(let i=0;i<13;i++){
        const td=document.createElement('td');
        if(i===0) td.textContent='TOTAL';
        else if(i===3) td.textContent=t10.toFixed(2);
        else if(i===4) td.textContent=t13.toFixed(2);
        else if(i===7) td.textContent=tDed.toFixed(2);
        else if(i===8) td.textContent=tSz.toFixed(2);
        else if(i===9) td.textContent=tNet10.toFixed(2);
        else if(i===10) td.textContent=tNet13.toFixed(2);
        else if(i===12) td.textContent=tQ.toFixed(0);
        else td.textContent='';
        totalRow.appendChild(td);
      }
      tbody.appendChild(totalRow);
    }

    renderAccountsTableFor(accounts, 'qryAccTable');
  }

  // ---------- ACCOUNTS TABLE (REUSABLE) ----------
  function renderAccountsTableFor(accounts, tableId) {
    const tbody = document.querySelector('#'+tableId+' tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    let totalAmt = 0;

    accounts.forEach(r => {
      const amt = safeNumber(r['AMOUNT']);
      totalAmt += amt;
      const sub = safeString(r['PAYMENT SUB TYPE'] || r['PAYMENT SUB-TYPE'] || r['PAYMENT SUBTYPE']);
      const remarks = safeString(r['REMARKS'] || r['NOTE'] || r['NARRATION']);
      const toBank = safeString(r['TO BANK']) || safeString(r['ACTUAL TO']);

      const tr = document.createElement('tr');
      const cells = [
        safeString(r['DATE']),
        safeString(r['FROM']),
        safeString(r['VIA']),
        safeString(r['TO']),
        toBank,
        amt.toFixed(0),
        safeString(r['PAYMENT TYPE']),
        sub,
        safeString(r['CATEGORY']),
        remarks
      ];
      cells.forEach(c => {
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    if (accounts.length) {
      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = '600';
      for (let i = 0; i < 10; i++) {
        const td = document.createElement('td');
        if (i === 0) td.textContent = 'TOTAL';
        else if (i === 5) td.textContent = totalAmt.toFixed(0);
        else td.textContent = '';
        totalRow.appendChild(td);
      }
      tbody.appendChild(totalRow);
    }
  }
  // ---------- EXPORT HELPERS ----------
  function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(row => {
      const cells = Array.from(row.querySelectorAll('th,td'));
      return cells.map(cell => {
        let text = cell.innerText.replace(/\r?\n|\r/g, ' ').trim();
        if (text.includes(',') || text.includes('"')) {
          text = '"' + text.replace(/"/g, '""') + '"';
        }
        return text;
      }).join(',');
    }).join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  }

  function exportTableToPDF(tableId, title) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const win = window.open('', '_blank');
    win.document.write('<html><head><title>' + title + '</title>');
    win.document.write('<style>body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:11px;} table{border-collapse:collapse;width:100%;font-size:11px;} th,td{border:1px solid #333;padding:4px 6px;text-align:left;}</style>');
    win.document.write('</head><body>');
    win.document.write('<h3>' + title + '</h3>');
    win.document.write(table.outerHTML);
    win.document.write('</body></html>');
    win.document.close();
    win.focus();
    win.print();
  }

</script>
</body>
</html>
